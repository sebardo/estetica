{% extends "BackendBundle::layout.html.twig" %}

{% set active_side_bar = 'creativity-proposal' %}

{% block stylesheets %}
    {{ parent() }}
    {% stylesheets
    'bundles/editor/css/editor.css'
    filter='cssrewrite' %}
    <link rel="stylesheet" href="{{ asset_url }}"/>
    {% endstylesheets %}
{% endblock %}

{% block content_header %}{% endblock %}
{% block content %}

    <!-- Content Header (Page header) -->
    <section class="content-header">
      <h1>
        {{ 'templates' | trans }}
        <small></small>
      </h1>
      <ol class="breadcrumb">
        <li><a href="#"> <i class="ion-home"></i>  {{ 'marketing' | trans }}</a></li>
        <li><a href="{{ path('editor_editor_index') }}"> <i class="ion-image"></i>  {{ 'templates' | trans }}</a></li>
      </ol>
    </section>
      
      
    <!-- Main content -->
    <section class="content">
      <div class="row">
        <div class="col-xs-12">
                        
          <div class="box">
            <div class="box-body">

                
                {% if app.user.isGranted('ROLE_ADMIN') == false %}
                <form action="#" method="GET">
                    <div class="form-group">
                        <label class="" for="support-selection">{{ 'creativity_order.select.support'|trans() }}</label>
                        <select class="form-control" name="support" id="support-selection">
                            {% for key, support in supportCollection %}
                                <option value="{{ key }}">{{ support|trans() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="" for="category-selection">{{ 'creativity_order.select.category'|trans() }}</label>
                        <select class="form-control" name="category" id="category-selection">
                            {% for key, category in categoryCollection %}
                                <option value="{{ key }}">{{ category|trans() }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </form>
                <div class="row" id="creativity-selection"></div>
                {% else %}
                <div class="clearfix">
                    <div class="btn-group">
                        <a href="{{ path('editor_editor_new') }}" class="btn btn-success btn-flat">
                             {{ 'add.new' | trans }} <i class="ion-plus"></i>
                        </a>
                    </div>
                </div>            
                {% endif %}        
                
                <table class="table table-striped table-bordered table-hover" id="templates-table">
                    <thead>
                    <tr>             
                        <th>Id</th>
                        <th>Soporte</th>        
                        <th>Categoría</th>       
                        <th>Fondo de 1er cara de creatividad</th>        
                        <th style="width: 200px"></th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                </table>
              </div>
          </div>
                
                
            {% if app.user.isGranted('ROLE_ADMIN') == false %}
                <h3>
                    Historial de creatividades del cliente "{{ app.user.tradeName }}"
                  <small></small>
                </h3>
                <div class="box">
                    <div class="box-body">
                        <table class="table table-striped table-bordered table-hover" id="templates-client-table">
                            <thead>
                            <tr>             
                                <th>Id</th>
                                <th>Soporte</th>        
                                <th>Categoría</th>       
                                <th>Fondo de 1er cara de creatividad</th>        
                                <th style="width: 200px"></th>
                            </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>  
            {% endif %} 
        </div>
      </div>
    </section>     
                
{% endblock %}

{% block javascripts %}
    {{ parent() }}
        
        {% javascripts 
            'bundles/editor/js/table-managed.js'
             %}
            <script type="text/javascript" src="{{ asset_url }}"></script>
        {% endjavascripts %}
        
    <script>
        var table_columns = [     
            {
                "mData": function (source) {
                    return '<a href="editor/' + source.id + '">' + source.id + '</a>';
                }
            },
            { "mData": "support" },
            { "mData": "category" },
            {
                "mData": function (source) {
                    return '<img width="100" src="/uploads/templates/' + source.image + '" /img>';
                }
            },
            {
                "mData": function(source) {

                    var html = '<a href="/admin/editor/edit/' + source.id + '" class="btn btn-primary btn-xs btn-flat ">  {{ 'edit' | trans }}</a> ';
                    return html;
                } 
            }
        ];
        
        var table_columns2 = [     
            {
                "mData": function (source) {
                    return '<a href="editor/' + source.id + '">' + source.id + '</a>';
                }
            },
            { "mData": "support" },
            { "mData": "category" },
            {
                "mData": function (source) {
                    return '<img width="100" src="/uploads/templates/' + source.image + '" /img>';
                }
            },
            {
                "mData": function(source) {
                    {% if app.user.isGranted('ROLE_ADMIN') == false %}
                        var html = '<span data="/admin/editor/clone/' + source.id + '" class="btn btn-primary btn-xs btn-flat clone-template">  {{ 'template.clone' | trans }}</span> ';
                    {% else %}
                        var html = '<a href="/admin/editor/edit/' + source.id + '" class="btn btn-primary btn-xs btn-flat">  {{ 'edit' | trans }}</a> ';
                    {% endif %}
                    return html;
                } 
            }
        ];

        jQuery(document).ready(function() {
        
            TableManaged.init(
                '#templates-table',
                '{{ url('editor_editor_listjson') }}',
                [],
                table_columns2,
                '{{ url('editor_editor_getdatatablesi18n', { language: app.request.locale }) }}',
                function(){
                    $('.clone-template').click(function(){
                        $.ajax({
                            url: $(this).attr('data'),
                            type: "GET",
                            dataType: "json",
                            async: true,
                            success: function (data) {
                                console.log(data)
                                if(parseInt(data)>0){
                                    TableManaged.reload(
                                        '#templates-client-table',
                                        '{{ url('editor_editor_listjson') }}?client={{app.user.id}}',
                                        [],
                                        table_columns,
                                        '{{ url('editor_editor_getdatatablesi18n', { language: app.request.locale }) }}'
                                    );
                                }

                            }
                        });

                    });
                }
            );
    
            TableManaged.init(
                '#templates-client-table',
                '{{ url('editor_editor_listjson') }}?client={{app.user.id}}',
                [],
                table_columns,
                '{{ url('editor_editor_getdatatablesi18n', { language: app.request.locale }) }}',
                function(){
                    //callback
                }
            );
     
            $('.clone-template').click(function(){
                $.ajax({
                    url: $(this).attr('data'),
                    type: "GET",
                    dataType: "json",
                    async: true,
                    success: function (data) {
                        console.log(data)
                        if(parseInt(data)>0){
                            TableManaged.reload(
                                '#templates-client-table',
                                '{{ url('editor_editor_listjson') }}?client={{app.user.id}}',
                                [],
                                table_columns,
                                '{{ url('editor_editor_getdatatablesi18n', { language: app.request.locale }) }}'
                            );
                        }

                    }
                });

            });
            
        });
 
        function getCreativies(selector, data) {
            TableManaged.reload(
                '#templates-table',
                '{{ url('editor_editor_listjson') }}?support='+$('#support-selection').val()+'&category='+$('#category-selection').val(),
                [],
                table_columns2,
                '{{ url('editor_editor_getdatatablesi18n', { language: app.request.locale }) }}'
            );
        }

        
        $('#support-selection').on('change', function() {
           var $this = $(this);
           if(checkFields(['#support-selection', '#category-selection'])) {
               var $category = $('#category-selection');
               var data = {
                   support: $this.val(),
                   category: $category.val()
               };
               getCreativies('#creativity-selection', data)
           }
        });

        $('#category-selection').on('change', function() {
            var $this = $(this);
            if(checkFields(['#support-selection', '#category-selection'])) {
                var $support = $('#support-selection');
                var data = {
                    support: $support.val(),
                    category: $this.val()
                };
                getCreativies('#creativity-selection', data)
            }
        });

        function checkFields(selectors) {
            var response = true;
            selectors = Array.isArray(selectors) ? selectors : [selectors];
            selectors.forEach(function(item, index) {
                var value = $(item).val();
                if(value === 'undefined') {
                    response = false;
                }
            });

            return response;
        }

    </script>
{% endblock %}